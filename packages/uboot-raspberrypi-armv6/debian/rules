#!/usr/bin/make -f

include /usr/share/dpkg/architecture.mk
include /usr/share/dpkg/pkg-info.mk

ifneq ($(DEB_BUILD_GNU_TYPE),$(DEB_HOST_GNU_TYPE))
CROSS_COMPILE ?= $(DEB_HOST_GNU_TYPE)-
endif

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
NJOBS := -j $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
else
NJOBS := -j $(shell nproc)
endif

raspberrypi:
	@mkdir -p debian/build/$@
	@touch .scmversion

	make CROSS_COMPILE=$(CROSS_COMPILE) ARCH=arm $(NJOBS) rpi_0_w_defconfig
	@sed -i 's/CONFIG_LOCALVERSION=""/CONFIG_LOCALVERSION="-raspberrypi"/g' .config
	@sed -i 's/CONFIG_DISABLE_CONSOLE=y/CONFIG_DISABLE_CONSOLE=n/g' .config
	make CROSS_COMPILE=$(CROSS_COMPILE) SOURCE_DATE_EPOCH=$(shell date +%s) ARCH=arm $(NJOBS)
	mv u-boot.bin ../u-boot-rpi-0-w.bin

	make CROSS_COMPILE=$(CROSS_COMPILE) ARCH=arm $(NJOBS) clean
	make CROSS_COMPILE=$(CROSS_COMPILE) ARCH=arm $(NJOBS) rpi_defconfig
	@sed -i 's/CONFIG_LOCALVERSION=""/CONFIG_LOCALVERSION="-raspberrypi"/g' .config
	@sed -i 's/CONFIG_DISABLE_CONSOLE=y/CONFIG_DISABLE_CONSOLE=n/g' .config
	make CROSS_COMPILE=$(CROSS_COMPILE) SOURCE_DATE_EPOCH=$(shell date +%s) ARCH=arm $(NJOBS)
	mv u-boot.bin ../u-boot-rpi.bin
	
build: raspberrypi

binary-raspberrypi:
	rm -rf debian/build/boot
	mkdir -m 755 -p debian/build/boot
	mv ../u-boot-rpi-0-w.bin debian/build/boot
	mv ../u-boot-rpi.bin debian/build/boot

	mkdir -m 755 -p "debian/build/DEBIAN"
	mkdir -p "debian/build/usr/share/doc/uboot-raspberrypi-armv6"
	cp debian/copyright "debian/build/usr/share/doc/uboot-raspberrypi-armv6/"
	cp debian/changelog "debian/build/usr/share/doc/uboot-raspberrypi-armv6/changelog.Debian"
	gzip -f -9 "debian/build/usr/share/doc/uboot-raspberrypi-armv6/changelog.Debian"
	sh -c "cd 'debian/build'; find . -type f ! -path './DEBIAN/*' -printf '%P\0' | xargs -r0 md5sum > DEBIAN/md5sums"
	chown -R root:root "debian/build" && chmod -R go-w "debian/build" && chmod -R a+rX "debian/build"
	dpkg-gencontrol -puboot-raspberrypi-armv6 -P"debian/build"
	dpkg --build "debian/build" ..

binary-arch: binary-raspberrypi

binary: binary-arch

clean:
	@rm -rf debian/*tmp debian/tmp debian/build debian/files
	$(MAKE) clean